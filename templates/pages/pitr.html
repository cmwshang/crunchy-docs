{%extends "base.html" %}
  {%block title%}Pitr | Crunchy Container Suite{%endblock%}
  {%block pagetitle%}Crunchy Container Suite{%endblock%}
  {%block content%}
<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph"><p>PITR (point-in-time-recovery) is a feature that lets a DBA
recreate a database from backup and log files at a certain
point in time.  This is useful in that the log files record
only the small changes made to a database over time.  For
large databases, doing a full database backup is not workable
given the time and space it requires.  Therefore, with PITR,
you only need to save the log files plus a known full backup
to recreate your database in the event of a database or system
failure.</p></div>
<div class="paragraph"><p>Support was added into the Crunchy Container Suite as of version 1.2.3.</p></div>
<div class="paragraph"><p>This document will discuss the design and usage of the PITR features
as implemented so far.</p></div>
<div class="sect2">
<h3 id="_wal">WAL</h3>
<div class="paragraph"><p>Write Ahead Logs (WAL) is created when you enable continuous archiving
as described <a href="https://www.postgresql.org/docs/9.5/static/continuous-archiving.html">here.</a></p></div>
<div class="paragraph"><p>By default in the crunchy-postgres container, WAL logging is <strong>not</strong> enabled.
To enable WAL logging, you set the following environment variables
when starting the crunchy-postgres container:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>ARCHIVE_MODE=on
ARCHIVE_TIMEOUT=60</code></pre>
</div></div>
<div class="paragraph"><p>These variables set the same name settings within the postgresql.conf
file that is used by the database.</p></div>
<div class="paragraph"><p>When set, WAL files generated by the database will be written
out to the /pgwal mount point.</p></div>
</div>
<div class="sect2">
<h3 id="_restoring_from_wal">Restoring from WAL</h3>
<div class="paragraph"><p>A full backup is required to do a PITR.  crunchy-backup currently
performs this role, running a pg_basebackup for you.  This is required
for PITR.</p></div>
<div class="paragraph"><p>After a backup has been performed, code was added into crunchy-postgres
which during a backup restore, will also check to see if you want
to do a PITR.</p></div>
<div class="paragraph"><p>When you run a crunchy-postgres container and specify
a /recover volume mount, this will trigger logic for PITR
during container startup.</p></div>
<div class="paragraph"><p>/backup will still be used to find the base backup you want to use, just
like a normal database backup restore.</p></div>
<div class="paragraph"><p>/pgwal can still be used to write out new WAL files from the
restored database container.</p></div>
<div class="paragraph"><p>The RECOVERY_TARGET_NAME environment variable is used to tell the PITR
logic what target name you want to use for the PITR.  RECOVERY_TARGET_TIME
is also an optional environment variable that lets you restore
using a known time stamp.  If you don&#8217;t specify either of these
environment variables, then the PITR logic will assume you want to
restore using all the WAL files or essentially the last known recovery point.</p></div>
<div class="paragraph"><p>The RECOVERY_TARGET_INCLUSIVE environment variable is also available to
let you control the setting of the recovery.conf setting <strong>recovery_target_inclusive</strong>.  If you do not set this environment variable the default is <strong>true</strong>.</p></div>
</div>
<div class="sect2">
<h3 id="_hint">Hint</h3>
<div class="paragraph"><p>Once you recover a database using PITR, it will be in read-only mode.  To
make the database resume as a writable database, run the following
sql command:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>select pg_xlog_replay_resume();</code></pre>
</div></div>
<div class="paragraph"><p>This command changed for PG10 to:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>postgres=# select pg_wal_replay_resume();</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_examples">Examples</h3>
<div class="paragraph"><p>Examples for PITR have been created within the standalone, openshift,
and kubernetes examples directories.</p></div>
<div class="paragraph"><p>There is a blog on how the example works documented here:
<a href="https://blog.openshift.com/crunchy-postgresql-containers-on-openshift-performing-point-in-time-recovery/">https://blog.openshift.com/crunchy-postgresql-containers-on-openshift-performing-point-in-time-recovery/</a></p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_legal_notices">Legal Notices</h2>
<div class="sectionbody">
<div class="paragraph"><p>Copyright Â© 2018 Crunchy Data Solutions, Inc.</p></div>
<div class="paragraph"><p>CRUNCHY DATA SOLUTIONS, INC. PROVIDES THIS GUIDE "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF NON INFRINGEMENT, MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.</p></div>
<div class="paragraph"><p>Crunchy, Crunchy Data Solutions, Inc. and the Crunchy Hippo Logo are trademarks of Crunchy Data Solutions, Inc.</p></div>
</div>
</div>
{% endblock %}
